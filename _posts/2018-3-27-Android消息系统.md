---
layout: post
title: "Android Handler消息系统解析"
date: 2018-03-26 23:58:34
comments: true
categories: 
## Android消息系统 ##
Android是一套由消息驱动的系统,主要依靠Handler、MessageQueue、Looper实现。

 1.Hanlder相当于一个工具类，封装了生成Message、分发Message的功能。
 2.MessageQueue则具体实现了Message的放入队列以及取出队列的逻辑.
 3.Looper死循环不停的取出消息交由Handler处理.
 
 **Handler.java**
 构造函数:
 
```
    public Handler(Callback callback) {
        //...
        mLooper = Looper.myLooper();//初始化Looper
         if (mLooper == null) {
            throw new RuntimeException("...");
         //Looper前必须要调用Looper.prepare(),否则报错。
        }
        mQueue = mLooper.mQueue;
        mCallback = callback;
    }
```
**Looper.java**
```
    //Looper放在一个ThreadLocal对象里面,由此可见一个线程只有一个Looper对象
    static final ThreadLocal<Looper> sThreadLocal = new ThreadLocal<Looper>();
    
     public static Looper myLooper() {
        return sThreadLocal.get();
    }
```
注：每个线程使用Looper前都需要prepare();主线程由于在ActivityThread创建时就已经调用过了，所以不需要手动调用，其他线程需要手动调用。

**Looper.prepare()**;
```
 public static void prepare() {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException("Only one Looper may be created per thread");
        }
        sThreadLocal.set(new Looper());
    }
```    
 

 
 
 










